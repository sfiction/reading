

- `ar`, 处理静态库
  - `lib`, windows ver
- `collect2`
- `objdump`
  - `-d`, 反汇编
- `readelf`
  - `-r`, 重定位表
  - `-s`, 符号表
- `strip`, 去掉 elf 文件中的调试信息
- `--verbose`, 详细执行过程




### skip

Chapter 5

### Chapter 3

#### 3.4 ELF 文件结构描述


#### 3.5 链接的接口————符号

##### 3.5.4 extern "C"

C 和 C++ 对文件名的修饰规则不同。因此 C++ 代码直接包含 C 库头文件，所生成的目标文件中文件名会经过修饰，导致在链接阶段无法找到相应库函数。`extern "C"` 可以将内部代码作为 C 语言代码处理，避免了这种错误的发生。

因为 C 中没有 `extern "C"` 语法。头文件作者一般用 `__cplusplus` 宏确定是否开启 `extern "C"`，以使得一份头文件可以同时支持 C 和 C++ 使用者。

##### 3.5.5 强符号与弱符号

强符号与弱符号
- 多个强符号: 报错
- 唯一强符号: 选择强符号
- 无强符号: 选择占用空间最大的弱符号

强引用与弱引用: 强引用不存在时报错，弱引用不报错

`__attribute__((weak))`, `__attribute__((weakref))`

用弱符号和弱引用增强程序扩展性。

### Chapter 4 静态链接

#### 4.1 空间与地址分配

##### 4.1.1 按序叠加

由于每个段都有一定地址和空间对齐要求。例如 `x86` 硬件每段的装载地址和空间对齐单位为页。简单按序叠加会导致产生大量内部碎片。

##### 4.1.2 相似段合并

空间分配: 可执行文件中的空间；虚拟地址空间

VMA, LMA

两步链接
1. 空间与地址分配
2. 符号解析与重定位

Linux 下，ELF 可执行文件默认从 `0x08048000` 开始分配虚拟地址。

#### 4.2 符号解析与重定位

空间与地址分配自后，所有符号的地址都已确定。链接器根据**重定位表**修正每个需要重定位的指令。

`x86` 一般绝对寻址修正前的值为 0。书中相对寻址的计算有些繁复，按照 `S+A-P` 计算方法，原值 `A` 应该是该修正位置长度的相反数，这样 `P-A` 就是下一条指令的地址，符合相对寻址指令的一般定义。

#### 4.3 COMMON 块

COMMON 块机制。同名弱符号类型，长度（类型）不一致时选择占用空间最大者。

#### 4.4 C++ 相关问题

##### 4.4.1 重复代码消除

多目标文件时可能的重复代码来源
- 模板代码
- 外部内联函数
- 虚函数表

重复代码导致空间浪费、无法用地址判断同一函数、缓存低效。

模板重复代码的一种解决方案：将每个实例的代码放在单独段中，用段名作为标识。其他类型的重复代码解决方案类似。

目标文件包含大量无用代码，可用函数级别链接，每个函数放在单独段中。缺点是需要在链接时计算函数依赖关系，拖慢速度。`-ffunction-sections`, `-fdata-sections`

##### 4.4.2 全局构造与析构

main 前的初始化工作：例如全局对象的构造函数
main 后的清理工作：例如全局对象的析构函数

ELF 文件中的特殊段 `.init` 和 `.fini`。

##### 4.4.3 C++ 与 ABI

统一的 ABI：令不同来源的目标文件可以相互链接

	- <SICP>
	- <CSAPP>
	- Machine Learning
		- <Neural Networks and Deep Learning>, 2, p34
			- 目标：画风归类、作者识别、人物识别
		- <人工智能>
		- <PRML>, 1.5, p33
		- 西瓜书
	- UNIX
		- <Advanced Programming in the UNIX Environment>
		- Shell
			- <Learning the Bash Shell>
ABI 包含的部分内容：
- 符号修饰标准
- 变量内存布局
- 函数调用方式

C ABI 还包括：堆栈分布方式、寄存器使用约定等
C++ ABI 还包括：寄存类体系的内存分布、成员函数指针的内存分布、虚函数表、模板实例化方式、全局对象构造和析构、异常机制、标准库细节、内嵌函数、RTTI。

Linux Standard Base, Intel Itanium C++ ABI

#### 4.6 链接过程控制

常用方法：
- 使用命令行指定参数
  - 将链接指令加入目标文件
- 使用链接控制脚本
  - ld 链接脚本语法简介

C 内联汇编

#### 4.7 BFD 库

交叉编译的主要手段？

### Chapter 6 可执行文件的装载与进程

